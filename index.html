<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Japanese Number Quiz — Global Leaderboard</title>
<style>
  :root{--bg:#121212;--panel:#1e1e1e;--ink:#e0e0e0;--muted:#9aa4ad;--accent:#90caf9;--ok:#7dff9b;--bad:#ff7b7b;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:880px;margin:28px auto;padding:0 16px}
  h1{margin:0 0 16px;font-size:28px}
  .box{background:var(--panel);border:1px solid #3a3a3a;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:16px}
  .grid{display:grid;gap:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-flex;justify-content:center;align-items:center;padding:10px 14px;border:1px solid #555;border-radius:10px;background:#2a2a2a;color:#fff;font-weight:700;cursor:pointer;transition:transform .05s ease,background .2s}
  .btn:hover{background:#3a3a3a}
  .btn:active{transform:translateY(1px)}
  .btn.sel{outline:2px solid var(--accent)}
  input[type=range]{width:100%}
  label{font-size:14px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #39424a;background:#171a1e;font-size:12px}
  .muted{color:var(--muted);font-size:13px}
  .q{font-size:22px}
  .btn-danger{background:#880000;border-color:#660000}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  ol{margin:8px 0 0 18px;padding:0}
  .sm{font-size:12px;opacity:.85}
  input[type=text]{width:100%;padding:10px;border:1px solid #555;border-radius:10px;background:#141414;color:var(--ink)}
  .cols-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:780px){.cols-3{grid-template-columns:1fr}}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#000;padding:2px 6px;border-radius:4px;border:1px solid #333}
</style>
</head>
<body>
<div class="wrap">
  <h1>Japanese Number Quiz</h1>

  <!-- HAUPTMENÜ -->
  <div class="box grid" id="menu">
    <div class="grid">
      <div class="row">
        <span><strong>Spielername:</strong></span>
        <input id="playerNameMenu" maxlength="16" placeholder="Dein Name (3–16)" style="max-width:260px">
        <span class="sm muted">Wird am Rundenende automatisch gespeichert.</span>
      </div>
    </div>

    <div class="grid">
      <div class="row">
        <span><strong>1) Schwierigkeit:</strong></span>
        <button id="easyBtn"   class="btn sel">Easy</button>
        <button id="mediumBtn" class="btn">Medium</button>
        <button id="hardBtn"   class="btn">Hard</button>
      </div>
      <div class="muted" id="difficultyDisplay">Selected: easy</div>
    </div>

    <div class="grid">
      <div><strong>2) Zeitlimit</strong></div>
      <label class="row"><input type="checkbox" id="noLimit" checked> Kein Zeitlimit</label>
      <input type="range" id="timeLimit" min="20" max="300" value="60" disabled>
      <div class="row"><span class="pill">Timer:</span><span id="timeDisplay">Disabled</span></div>
    </div>

    <div class="grid">
      <div><strong>3) Fragenanzahl</strong></div>
      <label class="row"><input type="checkbox" id="unlimitedQuestions"> Unbegrenzt</label>
      <input type="range" id="questionCount" min="5" max="100" value="10">
      <div class="row"><span class="pill">Questions:</span><span id="questionCountDisplay">10 questions</span></div>
      <label class="row"><input type="checkbox" id="countMode"> Count Mode (Anzeige: Zahl → Antwort: Romaji + Kanji)</label>
    </div>

    <div class="row" style="justify-content:space-between">
      <button id="startBtn" class="btn">Start Quiz</button>
      <span class="muted sm">Tipp: <span class="kbd">Esc</span> beendet Runde, <span class="kbd">Enter</span> bestätigt Antworten.</span>
    </div>

    <!-- LEADERBOARD (nur im Hauptmenü, unter den Optionen) -->
    <div class="grid" style="margin-top:8px">
      <div class="row" style="justify-content:space-between;align-items:baseline">
        <h3 style="margin:0">Globales Leaderboard</h3>
        <span class="pill" id="lbBackendInfo">lädt…</span>
      </div>
      <div class="cols-3">
        <div class="box">
          <div class="row" style="justify-content:space-between;align-items:baseline">
            <h4 style="margin:0">Easy</h4>
            <span class="sm muted" id="stampEasy"></span>
          </div>
          <ol id="lbEasy"><li class="muted">lade…</li></ol>
        </div>
        <div class="box">
          <div class="row" style="justify-content:space-between;align-items:baseline">
            <h4 style="margin:0">Medium</h4>
            <span class="sm muted" id="stampMedium"></span>
          </div>
          <ol id="lbMedium"><li class="muted">lade…</li></ol>
        </div>
        <div class="box">
          <div class="row" style="justify-content:space-between;align-items:baseline">
            <h4 style="margin:0">Hard</h4>
            <span class="sm muted" id="stampHard"></span>
          </div>
          <ol id="lbHard"><li class="muted">lade…</li></ol>
        </div>
      </div>
      <div class="sm muted">Hinweis: Leaderboards zeigen die Top-10 je Schwierigkeit (global geteilt über Supabase).</div>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quizPanel" class="box grid" style="display:none;margin-top:16px">
    <div class="row" style="justify-content:space-between;align-items:center">
      <button id="endQuizButton" class="btn btn-danger">Quiz beenden</button>
      <div id="progress" class="pill"></div>
    </div>
    <div id="question" class="q">Loading…</div>
    <div id="options" class="grid"></div>
    <div id="timer" class="muted"></div>
  </div>

  <!-- SUMMARY (ohne Leaderboard) -->
  <div id="summary" class="box grid" style="display:none;margin-top:16px">
    <h3 style="margin:0">Quiz Summary</h3>
    <p id="scoreLine">Score: 0/0</p>
    <p id="saveLine" class="muted sm">Speichere Ergebnis…</p>
    <div id="resultList"></div>
    <div class="row" style="justify-content:flex-end">
      <button id="btnBack" class="btn">Zurück zum Menü</button>
    </div>
  </div>
</div>

<!-- Supabase Config -->
<script>
  window.SUPABASE_URL = "https://btcsltamxkaguyhtgcyr.supabase.co";
  window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0Y3NsdGFteGthZ3V5aHRnY3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1OTU5NTAsImV4cCI6MjA3MDE3MTk1MH0.ttIP4OFQQAhR73Sihrj_RmLU9hk50i7qfrbKwsYN_C0";
</script>

<!-- Leaderboard API -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const url = window.SUPABASE_URL;
  const key = window.SUPABASE_ANON_KEY;
  const supabase = (url && key) ? createClient(url, key) : null;

  function getFingerprint(){
    const k = "quiz_fingerprint_v1";
    let f = localStorage.getItem(k);
    if(!f){ f = crypto.getRandomValues(new Uint32Array(4)).join("-"); localStorage.setItem(k, f); }
    return f;
  }

  async function submitScore({ name, points, mode }){
    if(!name || name.length < 3 || name.length > 16) throw new Error("Name 3–16 Zeichen.");
    if(!Number.isInteger(points) || points < 0) throw new Error("Ungültige Punktzahl.");
    if(!mode || !["easy","medium","hard"].includes(mode)) throw new Error("Ungültiger Modus.");
    const fingerprint = getFingerprint();

    if(supabase){
      const { error } = await supabase.from("scores").insert({ name, points, mode, fingerprint });
      if(error) throw error;
    }else{
      const k = `scores_local_${mode}`;
      const list = JSON.parse(localStorage.getItem(k) || "[]");
      list.push({ name, points, mode, created_at: new Date().toISOString(), fingerprint });
      localStorage.setItem(k, JSON.stringify(list));
    }
  }

  async function topScores(mode, limit=10){
    if(supabase){
      const { data, error } = await supabase
        .from("scores")
        .select("name, points, mode, created_at")
        .eq("mode", mode)
        .order("points", { ascending: false })
        .order("created_at", { ascending: true })
        .limit(limit);
      if(error) throw error;
      return data || [];
    }else{
      const k = `scores_local_${mode}`;
      const list = JSON.parse(localStorage.getItem(k) || "[]");
      return list.sort((a,b)=> b.points - a.points || new Date(a.created_at) - new Date(b.created_at)).slice(0, limit);
    }
  }

  // Expose für Game-Logic
  window.LeaderboardAPI = { backend: supabase ? "supabase" : "local", submitScore, topScores };
</script>

<!-- Game Logic -->
<script>
  // State
  let questions = [];
  let currentQuestion = 0;
  let score = 0;
  let mode = "easy";
  let timer = null;
  let timeLeft = 0;
  let results = [];
  const numberData = [];

  // DOM
  const el = (id)=>document.getElementById(id);
  const startBtn = el("startBtn");
  const endQuizButton = el("endQuizButton");
  const quizPanel = el("quizPanel");
  const summary = el("summary");
  const menu = el("menu");

  // Numbers helpers
  function toKanji(n){
    if(n === 10000) return "一万";
    const digits = ['', '一','二','三','四','五','六','七','八','九'];
    const units  = ['', '十','百','千'];
    const s = String(n);
    let out = '';
    for(let i=0;i<s.length;i++){
      const d = Number(s[i]);
      const pos = s.length - i - 1;
      if(pos > 3) break;
      if(d === 0) continue;
      if(d === 1 && pos !== 0) out += units[pos];
      else out += digits[d] + units[pos];
    }
    return out || '零';
  }
  function toRomaji(n){
    if(n === 10000) return "ichiman";
    const ones = ["","ichi","ni","san","yon","go","roku","nana","hachi","kyuu"];
    const tens = ["","juu","ni juu","san juu","yon juu","go juu","roku juu","nana juu","hachi juu","kyuu juu"];
    const hundreds = ["","hyaku","ni hyaku","san byaku","yon hyaku","go hyaku","roppyaku","nana hyaku","happyaku","kyuu hyaku"];
    const thousands = ["","sen","ni sen","san zen","yon sen","go sen","roku sen","nana sen","hassen","kyuu sen"];
    let r = "";
    if(n >= 1000) r += thousands[Math.floor(n/1000)] + " ";
    if((n%1000) >= 100) r += hundreds[Math.floor((n%1000)/100)] + " ";
    if((n%100) >= 10) r += tens[Math.floor((n%100)/10)] + " ";
    if((n%10) > 0 || r.trim() === "") r += ones[n%10];
    return r.trim();
  }

  // Build dataset
  for(let i=1;i<=99;i++) numberData.push({ number:i, kanji:toKanji(i), romaji:toRomaji(i) });
  for(let i=100;i<=1000;i+=100) numberData.push({ number:i, kanji:toKanji(i), romaji:toRomaji(i) });
  for(let i=2000;i<=10000;i+=1000) numberData.push({ number:i, kanji:toKanji(i), romaji:toRomaji(i) });
  if(!numberData.some(n=>n.number===10000)) numberData.push({ number:10000, kanji:toKanji(10000), romaji:toRomaji(10000) });

  // UI bindings
  ["easyBtn","mediumBtn","hardBtn"].forEach(id=>{
    el(id).addEventListener("click", ()=>{
      ["easyBtn","mediumBtn","hardBtn"].forEach(b=>el(b).classList.remove("sel"));
      el(id).classList.add("sel");
      mode = id.replace("Btn","").toLowerCase();
      el("difficultyDisplay").textContent = `Selected: ${mode}`;
    });
  });

  el("questionCount").addEventListener("input",(e)=>{
    el("questionCountDisplay").textContent = `${e.target.value} questions`;
  });
  el("unlimitedQuestions").addEventListener("change",()=>{
    const u = el("unlimitedQuestions").checked;
    el("questionCount").disabled = u;
    el("questionCountDisplay").textContent = u ? "Unlimited" : `${el("questionCount").value} questions`;
  });
  el("noLimit").addEventListener("change",()=>{
    const nl = el("noLimit").checked;
    el("timeLimit").disabled = nl;
    el("timeDisplay").textContent = nl ? "Disabled" : `${el("timeLimit").value} seconds`;
  });
  el("timeLimit").addEventListener("input",(e)=>{
    el("timeDisplay").textContent = `${e.target.value} seconds`;
  });

  startBtn.addEventListener("click", startQuiz);
  endQuizButton.addEventListener("click", showSummary);
  el("btnBack").addEventListener("click", ()=>{
    summary.style.display = "none";
    menu.style.display = "grid";
    quizPanel.style.display = "none";
    loadAllLeaderboards(); // refresh after Runde
  });

  // Leaderboard (Menu) — lädt alle drei Listen
  async function loadAllLeaderboards(){
    el("lbBackendInfo").textContent = window.LeaderboardAPI.backend === "supabase"
      ? "Backend: Supabase (global geteilt)"
      : "Backend: lokal (nur dieser Browser)";
    await Promise.all([
      refreshLB("easy","lbEasy","stampEasy"),
      refreshLB("medium","lbMedium","stampMedium"),
      refreshLB("hard","lbHard","stampHard"),
    ]);
  }
  async function refreshLB(modeKey, listId, stampId){
    const list = el(listId);
    const stamp = el(stampId);
    list.innerHTML = "<li class='muted'>lade…</li>";
    try{
      const rows = await window.LeaderboardAPI.topScores(modeKey, 10);
      list.innerHTML = rows.length
        ? rows.map((r,i)=> `<li>#${i+1} — <b>${escapeHtml(r.name)}</b> · ${r.points} pts <span class="sm">(${new Date(r.created_at).toLocaleDateString()})</span></li>`).join("")
        : "<li class='muted'>Noch keine Einträge</li>";
      stamp.textContent = new Date().toLocaleTimeString();
    }catch(e){
      list.innerHTML = "<li class='muted'>Fehler beim Laden</li>";
      console.error(e);
    }
  }

  // Game helpers
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
  function generateOptions(q){
    const countMode = el("countMode").checked;
    const set = new Set();
    let correct;
    if(countMode){ correct = `${q.romaji} (${q.kanji})`; }
    else{
      if(mode==="easy") correct = q.number.toString();
      else if(mode==="medium") correct = q.romaji;
      else correct = q.kanji;
    }
    set.add(correct || "(undefined)");
    while(set.size<4){
      const r = numberData[Math.floor(Math.random()*numberData.length)];
      const v = countMode ? `${r.romaji} (${r.kanji})`
            : mode==="easy" ? r.number.toString()
            : mode==="medium" ? r.romaji
            : r.kanji;
      set.add(v);
    }
    return shuffle([...set]);
  }

  function startQuiz(){
    // Name validieren vor Start (damit Auto-Save klappt)
    const name = el("playerNameMenu").value.trim();
    if(name.length < 3 || name.length > 16){
      alert("Bitte Namen mit 3–16 Zeichen eingeben (fürs Leaderboard).");
      el("playerNameMenu").focus();
      return;
    }

    score = 0; currentQuestion = 0; results = [];
    const isUnlimited = el("unlimitedQuestions").checked;
    const isCountMode = el("countMode").checked;
    const qCount = parseInt(el("questionCount").value,10);
    const noLimit = el("noLimit").checked;
    const tLimit = parseInt(el("timeLimit").value,10);

    clearInterval(timer);
    if(!noLimit){
      timeLeft = tLimit;
      el("timer").textContent = `Time: ${timeLeft}s`;
      timer = setInterval(()=>{
        timeLeft--; el("timer").textContent = `Time: ${timeLeft}s`;
        if(timeLeft<=0){ clearInterval(timer); showSummary(); }
      },1000);
    }else{ el("timer").textContent = ""; }

    if(isCountMode){ questions = numberData.filter(n=>n.number>=1 && n.number<=100); }
    else{ questions = isUnlimited ? [] : shuffle([...numberData]).slice(0, qCount); }

    menu.style.display = "none";
    quizPanel.style.display = "grid";
    showQuestion();
  }

  function showQuestion(){
    const isUnlimited = el("unlimitedQuestions").checked;
    const isCountMode = el("countMode").checked;
    const total = (isUnlimited || isCountMode) ? null : questions.length;

    let q;
    if(isUnlimited){
      do{ q = numberData[Math.floor(Math.random()*numberData.length)]; }
      while(questions.length>0 && q.number === questions[questions.length-1]?.number);
      questions.push(q);
    }else{
      if(currentQuestion >= questions.length){ showSummary(); return; }
      q = questions[currentQuestion];
    }

    let prompt="", answer="";
    if(isCountMode){ prompt = `${q.number}`; answer = `${q.romaji} (${q.kanji})`; }
    else if(mode==="easy"){ prompt = `${q.kanji} (${q.romaji})`; answer = q.number.toString(); }
    else if(mode==="medium"){ prompt = `${q.number}`; answer = q.romaji; }
    else{ prompt = `${q.romaji}`; answer = q.kanji; }

    el("progress").textContent = total ? `Question ${currentQuestion+1} of ${total}` : `Question ${currentQuestion+1}`;
    el("question").textContent = prompt;

    const box = el("options"); box.innerHTML = "";
    generateOptions(q).forEach(opt=>{
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = opt;
      b.onclick = ()=>{
        const correct = (opt === answer);
        if(correct) score++;
        results.push({ question: prompt, correctAnswer: answer, userAnswer: opt, isCorrect: correct });
        currentQuestion++; showQuestion();
      };
      box.appendChild(b);
    });
  }

  async function showSummary(){
    clearInterval(timer);
    quizPanel.style.display = "none";
    summary.style.display = "grid";
    el("scoreLine").textContent = `Score: ${score}/${results.length}`;

    // Auto-Save des Scores (kein Leaderboard hier)
    const name = el("playerNameMenu").value.trim();
    const saveLine = el("saveLine");
    try{
      await window.LeaderboardAPI.submitScore({ name, points: score, mode });
      saveLine.textContent = `Gespeichert als "${name}" (${mode}). Öffne das Hauptmenü, um die Bestenliste zu sehen.`;
    }catch(e){
      saveLine.textContent = "Konnte nicht speichern (offline oder Fehler). Versuch es später erneut.";
      console.error(e);
    }

    // Ergebnisse anzeigen
    const rl = el("resultList"); rl.innerHTML = "";
    for(let i=0;i<results.length;i++){
      const r = results[i];
      const p = document.createElement("p");
      p.innerHTML = `Q${i+1}: ${escapeHtml(r.question)} → <span class="${r.isCorrect?'ok':'bad'}">${escapeHtml(r.userAnswer)}</span> (Correct: ${escapeHtml(r.correctAnswer)})`;
      rl.appendChild(p);
    }
  }

  // HTML escape
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}

  // Initial Leaderboards
  (async ()=>{ await loadAllLeaderboards(); })();

  // Tastaturkürzel
  window.addEventListener("keydown",(e)=>{
    if(e.key==="Escape" && quizPanel.style.display!=="none"){ showSummary(); }
  });
</script>
</body>
</html>
